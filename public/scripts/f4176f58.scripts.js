"use strict";window.app=angular.module("ngl2",["ngResource","ngCookies","ngl2.controllers","ngl2.services","ngl2.directives","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/static/intro.html"}).when("/login",{templateUrl:"views/auth/login.html"}).when("/trees",{templateUrl:"views/trees/list.html",controller:"TreesCtrl"}).when("/trees/:treeId",{templateUrl:"views/trees/interface.html"}).when("/trees/:treeId/people/create",{templateUrl:"views/people/create.html"}).when("/trees/:treeId/people/:personId/create",{templateUrl:"views/people/create.html"}).when("/trees/:treeId/people/:personId/edit",{templateUrl:"views/people/edit.html"}).otherwise({redirectTo:"/"})}]).config(["$httpProvider",function(a){delete a.defaults.headers.common["X-Requested-With"]}]),angular.module("ngl2.controllers",["ngl2.controllers.main","ngl2.controllers.trees","ngl2.controllers.people","ngl2.controllers.account"]),angular.module("ngl2.services",["ngl2.services.global","ngl2.services.auth","ngl2.services.trees","ngl2.services.people"]),angular.module("ngl2.directives",["ngl2.directives.tree"]),window.angular.module("ngl2.services.auth",["ngCookies"]).factory("Auth",["$http","$cookieStore",function(a,b){var c={};c.user=b.get("user")||{},c.token=function(){return c.user.token},c.loggedIn=function(){return c.user&&c.user.token},c.login=function(b,c,e,f){a({method:"POST",url:"http://localhost:3000/api/v1/users/sign_in",data:{email:b,password:c,remember_me:e}}).success(function(a){d.call(this,a,f)})},c.register=function(b,c,e,f){a({method:"POST",url:"http://localhost:3000/api/v1/users",data:{user:{email:b,password:c,password_confirmation:e}}}).success(function(a){d.call(this,a,f)})},c.logout=function(d){a({method:"DELETE",url:"http://localhost:3000/api/v1/users/sign_out?auth_token="+c.token()}).success(function(){c.user={},b.put("user",c.user),d()})};var d=function(a,d){a.user.token=a.authentication_token,c.user=a.user,b.put("user",c.user),d&&d()};return c}]),window.angular.module("ngl2.services.trees",[]).factory("Trees",["$resource","$rootScope","$location","Auth",function(a,b,c,d){function e(){var a,b,c=0,d=[];for(c in g)a=g[c],b={_id:a._id,birth_name:a.birth_name,dob:a.dob,dod:a.dod},d.push(b);return d}window._;var f,g={};return d.token()||c.path("/"),{reset:function(){f=void 0,g={}},getPeople:function(){return g},getPerson:function(a){return g[a]},deletePerson:function(a){return delete g[a],g},updatePeople:function(a,c){var d,f=0;for(f in a)d=a[f],g[d._id]=d;if(c){c=[].concat(c);for(f in c)d=c[f],delete g[d._id]}return b._peopleIndex=e(),g},resource:a("http://localhost:port/api/v1/trees/:treeId",{port:":3000",auth_token:d.token()},{update:{method:"PUT"},getData:{method:"GET",isArray:!1}})}}]),window.angular.module("ngl2.services.global",[]).factory("Global",["$http","$q",function(){}]),window.angular.module("ngl2.services.people",[]).factory("People",["$resource","Auth",function(a,b){var c=b.token();return a("http://localhost:port/api/v1/trees/:treeId/people/:personId",{port:":3000",auth_token:c,treeId:"@treeId",personId:"@_id"},{update:{method:"PUT"},getData:{method:"GET",isArray:!1}})}]),angular.module("ngl2.controllers.main",[]).controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),window.angular.module("ngl2.controllers.trees",[]).controller("TreesCtrl",["$scope","$rootScope","$routeParams","$location","Trees","Auth",function(a,b,c,d,e,f){return f.loggedIn()?(b._people=e.getPeople(),a.create=function(){console.log("submitted trees"),new e.resource({name:a.tree.name}).$save(function(a){d.path("/trees/"+a.tree._id)}),a.tree.name=""},a.find=function(){e.resource.getData({auth_token:f.token()},function(b){a.trees=b.trees})},a.findOne=function(){e.reset(),b._peopleIndex=[],e.resource.get({treeId:c.treeId,auth_token:f.token()},function(a){b.activeTree=a.tree,b._people=e.updatePeople(a.people)})},a.view=function(a){b.activeTree=a,d.path("/trees/"+a._id)},void 0):(d.path("/"),void 0)}]),window.angular.module("ngl2.controllers.people",[]).controller("PeopleCtrl",["$scope","$rootScope","$routeParams","$location","$http","$filter","$route","Auth","Trees","People",function(a,b,c,d,e,f,g,h,i,j){function k(a){switch(a){case"child":return"parents";case"parent":return"children";case"spouse":return"spouses"}}b.activePerson={},a.searchText="",a.editForm=function(a){d.path("trees/"+a.tree_id+"/people/"+a._id+"/edit")},a.edit=function(){a.person=i.getPerson(c.personId),void 0===a.person&&d.path("trees/"+c.treeId)},a.update=function(){var b={_id:a.person._id,treeId:c.treeId,auth_token:h.token(),person:a.person};new j(b).$update(function(){d.path("trees/"+c.treeId)})},a.addPerson=function(){$(".modal").modal()},a.addRelation=function(a){var c=0,d=0,e=window.$,f=a.root;switch(console.log("add relation"),b.activePerson=f,b.action=a.create,b.suggestedRelatives={existing:[],parent:[],child:[],spouse:[]},e(".modal").modal(),b.action){case"child":b.suggestedRelatives.child=f.spouse_ids.map(function(a){return b._people[a]});for(c in f.spouse_ids){var g=b._people[f.spouse_ids[c]];for(d in g.child_ids)b.suggestedRelatives.existing.push(b._people[g.child_ids[d]])}break;case"spouse":b.suggestedRelatives.spouse=f.child_ids.map(function(a){return b._people[a]});for(c in f.child_ids){var h=b._people[f.child_ids[c]];for(d in h.parent_ids)b.suggestedRelatives.existing.push(b._people[h.parent_ids[d]])}break;case"parent":b.suggestedRelatives.parent=f.parent_ids.map(function(a){return b._people[a]});for(c in f.parent_ids){var i=b._people[f.parent_ids[c]];for(d in i.spouse_ids)b.suggestedRelatives.existing.push(b._people[i.spouse_ids[d]])}}console.log("suggestedRelatives",b.suggestedRelatives)},a.updateRelation=function(){var d={_id:b.activePerson._id,treeId:c.treeId,person:{}};d.person[k(b.action)]=[a.relation],new j(d).$update(function(a){$(".modal").modal("hide"),b._people=i.updatePeople(a.people),b.activePerson=a.people[0]})},a.create=function(){var d=window.$,e=b.activePerson._id,g={treeId:c.treeId,person:a.newPerson};if(b.action)switch(g.person.children=[],g.person.parents=[],g.person.spouses=[],b.action){case"child":g.person.parents=[e],a.additionalRelation&&g.person.parents.push(a.additionalRelation);break;case"parent":g.person.children=[e],a.additionalRelation&&g.person.spouses.push(a.additionalRelation);break;case"spouse":g.person.spouses=[e],g.person.children=f("filter")(a.suggestedRelatives.spouse,{checked:!0}).map(function(a){return a._id})}b.action=void 0,a.additionalRelation=void 0,a.newPerson=void 0,new j(g).$save(function(a){d(".modal").modal("hide"),b._people=i.updatePeople(a.people),console.log("we are here"),b.activePerson=i.getPerson(b.activePerson._id)})},a.destroy=function(){var e={treeId:c.treeId,_id:a.person._id};new j(e).$delete(function(a){b._people=i.updatePeople(a.people,a.person),d.path("trees/"+c.treeId)})},a.selectPerson=function(a){b.activePerson=b._people[a],console.log(b.activePerson)}}]),window.angular.module("ngl2.controllers.account",["ui.bootstrap"]).controller("AccountCtrl",["$scope","$rootScope","$modal","$location","$route","$log","Auth",function(a,b,c,d,e,f,g){a.loggedIn=g.loggedIn,a.logout=function(){g.logout(function(){b.activeTree=void 0,b.activePerson=void 0,b._people=void 0,d.path("/")})},a.login=function(){var b=c.open({templateUrl:"views/auth/login.html",controller:"LoginInstanceCtrl",windowClass:"show",resolve:{credentials:function(){return a.credentials}}});b.result.then(function(a){console.log("submitted creds",a),g.login(a.email,a.password,a.remember,function(){console.log("switch to trees",g.token()),d.path("trees")})},function(){f.info("Modal dismissed at: "+new Date)})},a.register=function(){var b=c.open({templateUrl:"views/auth/register.html",controller:"RegisterInstanceCtrl",windowClass:"show",resolve:{credentials:function(){return a.credentials}}});b.result.then(function(a){console.log("submitted creds",a),g.register(a.email,a.password,a.passwordConfirm,function(){d.path("trees")})},function(){f.info("Modal dismissed at: "+new Date)})}}]).controller("LoginInstanceCtrl",["$scope","$modalInstance","credentials",function(a,b,c){a.credentials=c,a.cancel=function(){b.dismiss("cancel")},a.login=function(){b.close(a.credentials)}}]).controller("RegisterInstanceCtrl",["$scope","$modalInstance","credentials",function(a,b,c){a.credentials=c,a.cancel=function(){b.dismiss("cancel")},a.login=function(){b.close(a.credentials)}}]),window.angular.module("ngl2.directives.tree",[]).directive("tree",["Trees",function(a){return{restrict:"A",scope:{person:"="},link:function(b,c){var d=window.d3,e=angular.copy(b.person),f=a.getPeople(),g=d.select(c[0]).append("svg:g").attr("transform","translate(20, 50)"),h=d.layout.tree().children(function(a){return a.spouses?a.children.concat(a.spouses):a.children}).size([150,150]),i=d.svg.diagonal().projection(function(a){return[a.y,a.x]}),j=function(a){var j,k,l,m=0,n=0;if(a){g.remove(),g=d.select(c[0]).append("svg:g").attr("transform","translate(20, 50)"),e=angular.copy(b.person),e.children=[],e.spouses=[];for(m in e.spouse_ids){j=e.spouse_ids[m],k=angular.copy(f[j]),l=[];for(n in k.child_ids)j=k.child_ids[n],e.child_ids.indexOf(j)>-1&&l.push(angular.copy(f[j]));l.length&&(k.children=l),e.spouses.push(k)}var o=h.nodes(e),p=h.links(o);g.selectAll("pathlink").data(p.filter(function(a){return a.source.child_ids.indexOf(a.target._id)>-1})).enter().append("svg:path").attr("class","link").attr("d",i),g.selectAll("pathlink").data(p.filter(function(a){return a.source.spouse_ids.indexOf(a.target._id)>-1})).enter().append("svg:path").attr("class","link spouse").attr("stroke-dasharray","4,4").attr("d",i);var q=g.selectAll("g.node").data(o).enter().append("svg:g").attr("transform",function(a){return"translate("+a.y+","+a.x+")"}).attr("class",function(a){if(void 0!==a.gender){var b="";return a.gender&&(b+=1===a.gender?"m":"f"),b}});q.append("svg:circle").attr("r",3.5),q.append("svg:text").text(function(a){return a.birth_name}).attr("transform",function(){return"rotate(-45)translate(6,2)"})}};b.$watch("person",j,!0)}}}]);